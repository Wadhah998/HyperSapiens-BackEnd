version: '3.8'

services:
  # Neo4j Database
  neo4j:
    image: neo4j:5.15-community
    container_name: hyper-sapiens-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/24259043
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p 24259043 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 15s
      retries: 5
      start_period: 60s
    networks:
      - hyper-sapiens-network

  # User Service
  user-service:
    image: wadhahdaoud/hyper-sapiens-user-service:latest
    container_name: hyper-sapiens-user-service
    ports:
      - "3001:3001"
    environment:
      - SERVICE_NAME=user-service
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=24259043
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=1d
      - FRONTEND_URL=${FRONTEND_URL}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3001/graphql', (r) => {process.exit(r.statusCode === 200 || r.statusCode === 400 ? 0 : 1)})\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Auth Service
  auth-service:
    image: wadhahdaoud/hyper-sapiens-auth-service:latest
    container_name: hyper-sapiens-auth-service
    ports:
      - "3002:3002"
    environment:
      - SERVICE_NAME=auth-service
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=1d
      - USER_SERVICE_URL=http://user-service:3001/graphql
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3002/graphql', (r) => {process.exit(r.statusCode === 200 || r.statusCode === 400 ? 0 : 1)})\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Project Service
  project-service:
    image: wadhahdaoud/hyper-sapiens-project-service:latest
    container_name: hyper-sapiens-project-service
    ports:
      - "3003:3003"
    environment:
      - SERVICE_NAME=project-service
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=24259043
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=1d
      - API_BASE_URL=http://localhost:3000
      - N8N_WEBHOOK_URL=http://n8n:5678/webhook/analyze-cahier-charge
    depends_on:
      neo4j:
        condition: service_healthy
      n8n:
        condition: service_healthy
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3003/graphql', (r) => {process.exit(r.statusCode === 200 || r.statusCode === 400 ? 0 : 1)})\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Hyperdev Service
  hyperdev-service:
    image: wadhahdaoud/hyper-sapiens-hyperdev-service:latest
    container_name: hyper-sapiens-hyperdev-service
    ports:
      - "3004:3004"
    environment:
      - SERVICE_NAME=hyperdev-service
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=24259043
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=1d
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3004/graphql', (r) => {process.exit(r.statusCode === 200 || r.statusCode === 400 ? 0 : 1)})\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # API Gateway
  api-gateway:
    image: wadhahdaoud/hyper-sapiens-api-gateway:latest
    container_name: hyper-sapiens-api-gateway
    ports:
      - "3000:3000"
    environment:
      - SERVICE_NAME=api-gateway
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=1d
      # URLs des services dans le réseau Docker
      - USER_SERVICE_URL=http://user-service:3001/graphql
      - AUTH_SERVICE_URL=http://auth-service:3002/graphql
      - PROJECT_SERVICE_URL=http://project-service:3003/graphql
      - HYPERDEV_SERVICE_URL=http://hyperdev-service:3004/graphql
    depends_on:
      user-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      project-service:
        condition: service_healthy
      hyperdev-service:
        condition: service_healthy
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http=require('http');const req=http.get('http://localhost:3000/graphql',(r)=>{r.resume();r.on('end',()=>process.exit(0));});req.on('error',(e)=>{console.error(e);process.exit(1);});setTimeout(()=>process.exit(1),5000);\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Frontend
  frontend:
    image: wadhahdaoud/hyper-sapiens-frontend:latest
    container_name: hyper-sapiens-frontend
    ports:
      - "5174:80"
    depends_on:
      - api-gateway
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1:80 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # N8N Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: hyper-sapiens-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - WEBHOOK_URL=http://n8n:5678/
      - GENERIC_TIMEZONE=UTC
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:5678/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Prometheus - Collecte de métriques
  prometheus:
    image: prom/prometheus:latest
    container_name: hyper-sapiens-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # Grafana - Visualisation des métriques
  grafana:
    image: grafana/grafana:latest
    container_name: hyper-sapiens-grafana
    ports:
      - "3005:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://146.59.236.129:3005
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Node Exporter - Métriques système (CPU, RAM, Disque)
  node-exporter:
    image: prom/node-exporter:latest
    container_name: hyper-sapiens-node-exporter
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:9100/metrics || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # cAdvisor - Métriques des conteneurs Docker
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: hyper-sapiens-cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg
    networks:
      - hyper-sapiens-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

networks:
  hyper-sapiens-network:
    driver: bridge

volumes:
  neo4j_data:
  neo4j_logs:
  n8n_data:
  prometheus_data:
  grafana_data:
  project_uploads:

